variables:
- name: SolutionBaseName
  value: Dfc.DevOps

resources:
  repositories:
  - repository: self
  - repository: dfc-devops
    type: github
    name: NickGraham101/dfc-devops
    endpoint: github.com_NickGraham101
    ref: refs/heads/AddMultipleAksAgentPools

pool:
  vmImage: ubuntu-latest

trigger:
  branches:
    include:
    - master

pr:
  branches:
    include:
    - master


stages:
- stage: BuildAndPublishContainers
  dependsOn: []
  variables:
  - group: owasp-k8s-test
  jobs:
  - template: JobTemplates\BuildAndPublishLinuxContainers.yml
    parameters:
      ContainerRegistryAdminUser: $(ContainerRegistryAdminUser)
      ContainerRegistryPassword: $(ContainerRegistryPassword)

- stage: DeployAzureDevOpsContainers
  condition: and(succeeded('BuildAndPublishContainers'), ne(variables['Build.Reason'], 'PullRequest'))
  dependsOn: BuildAndPublishContainers
  variables:
  - template: VariableTemplates\SharedEnvironmentVariables.yml
  - template: VariableTemplates\DevEnvironmentVariables.yml
  - group: owasp-k8s-test
  jobs:
  - template: JobTemplates\DeployContainers.yml
    parameters:
      AksResourceGroup: $(sharedResourceGroup)
      AzurePatToken: $(AzureDevOpsAgentPatToken)
      AzureSubscriptionEndpoint: 'Pay-As-You-Go (be945e1a-9f8e-460f-ba15-8d7f73e9e2e0)'
      Environment: DEV_SHARED
      KubernetesCluster: $(sharedAksCluster)